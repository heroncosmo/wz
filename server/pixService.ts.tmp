import { QrCodePix } from 'qrcode-pix';
import { storage } from './storage';

interface PixPaymentData {
  planNome: string;
  valor: number;
  subscriptionId: string;
}

export async function generatePixQRCode(paymentData: PixPaymentData) {
  try {
    const pixKeyConfig = await storage.getSystemConfig('pix_key');
    const pixKeyRaw = pixKeyConfig?.valor || 'rodrigoconexao128@gmail.com';
    // Normaliza chave: remove espaÃ§os e '+'; se for telefone com 11 dÃ­gitos, prefixa 55
    let pixKey = String(pixKeyRaw).replace(/\s+/g, '').replace(/^\+/, '').trim();
    if (/^\d+$/.test(pixKey)) {
      if (pixKey.length === 11) {
        // Telefone sem paÃ­s -> adiciona 55
        pixKey = '55' + pixKey;
      }
    }

    // TXID do Pix deve conter apenas caracteres [a-zA-Z0-9] e no mÃ¡ximo 25.
    const sanitizedTxId = (paymentData.subscriptionId || '')
      .replace(/[^a-zA-Z0-9]/g, '')
      .substring(0, 25) || 'TX' + Date.now().toString().slice(-23);

    const valor = typeof (paymentData as any).valor === 'string'
      ? parseFloat(String((paymentData as any).valor).replace(',', '.'))
      : Number(paymentData.valor || 0);

    // Normalizar campos de acordo com a especificaÃ§Ã£o EMVCo/Bacen
    const sanitizeText = (text: string, max: number) => {
      if (!text) return '';
      const normalized = text
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu, '') // remove acentos
        .replace(/[^A-Za-z0-9 \-\.&]/g, ' ') // apenas caracteres seguros
        .replace(/\s+/g, ' ') // colapsa espaÃ§os
        .trim();
      return normalized.slice(0, max);
    };

    const name = sanitizeText('WHATSAPP CRM SAAS', 25);
    const city = sanitizeText('SAO PAULO', 15);
    const message = sanitizeText(`Pagamento ${paymentData.planNome || ''}`.trim(), 50);

    const qrCodePix = QrCodePix({
      version: '01',
      key: pixKey,
      name,
      city,
      transactionId: sanitizedTxId,
      message,
      value: Number.isFinite(valor) && valor > 0 ? Number(valor.toFixed(2)) : 0.01,
      currency: 986,
      countryCode: 'BR',
    });

    const payload = qrCodePix.payload();
    // VerificaÃ§Ã£o bÃ¡sica: payload precisa terminar com CRC '6304' + 4 hex
    if (!/6304[0-9A-F]{4}$/i.test(payload)) {
      throw new Error('PIX payload invÃ¡lido: CRC ausente ou incorreto');
    }
    const qrCodeBase64 = await qrCodePix.base64();

    return {
      pixCode: payload,
      pixQrCode: qrCodeBase64,
    };
  } catch (error) {
    console.error('Error generating PIX QR Code:', error);
    throw error;
  }
}
