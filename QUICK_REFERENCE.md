# ğŸš€ ReferÃªncia RÃ¡pida - WhatsApp CRM SaaS

## ğŸ“š DocumentaÃ§Ã£o - Qual Ler?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NOVO NO PROJETO?                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. README_DOCUMENTATION.md (este arquivo)                   â”‚
â”‚ 2. SYSTEM_ARCHITECTURE.md (entender autenticaÃ§Ã£o)           â”‚
â”‚ 3. DEVELOPER_GUIDE.md (configurar e desenvolver)            â”‚
â”‚ 4. SYSTEM_FLOW_DIAGRAMS.md (visualizar fluxos)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QUER IMPLEMENTAR ALGO?                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. DEVELOPMENT_TASKLIST.md (encontre a tarefa)              â”‚
â”‚ 2. DEVELOPER_GUIDE.md (siga os passos)                      â”‚
â”‚ 3. SYSTEM_ARCHITECTURE.md (entenda o contexto)              â”‚
â”‚ 4. SYSTEM_FLOW_DIAGRAMS.md (visualize o fluxo)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PRECISA DEBUGAR?                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. SYSTEM_ARCHITECTURE.md â†’ Troubleshooting                 â”‚
â”‚ 2. SYSTEM_FLOW_DIAGRAMS.md â†’ Visualize o fluxo              â”‚
â”‚ 3. DEVELOPER_GUIDE.md â†’ Testes                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QUER VISÃƒO GERAL?                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. DOCUMENTATION.md (visÃ£o geral original)                  â”‚
â”‚ 2. SYSTEM_ARCHITECTURE.md (arquitetura migrada)             â”‚
â”‚ 3. SYSTEM_FLOW_DIAGRAMS.md (diagramas)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” AutenticaÃ§Ã£o - Cheat Sheet

### Supabase Auth (JWT) - UsuÃ¡rios Finais

**Arquivo:** `server/supabaseAuth.ts`

**Middleware:** `isAuthenticated`

**Fluxo:**
```
POST /api/auth/signin â†’ JWT token â†’ localStorage â†’ Authorization: Bearer <token>
```

**Rotas Protegidas:**
- GET /api/conversations
- POST /api/messages/:conversationId
- GET /api/subscriptions/current
- POST /api/agent/test
- GET /api/agent/config
- POST /api/agent/config
- POST /api/agent/toggle/:conversationId
- GET /api/agent/status/:conversationId

**Extrair User ID:**
```typescript
const userId = req.user.claims.sub;
```

---

### Admin Session - Administradores

**Arquivo:** `server/routes.ts` (linhas 35-87)

**Middleware:** `isAdmin` (server/middleware.ts)

**Fluxo:**
```
POST /api/admin/login â†’ req.session.adminId â†’ Cookie: connect.sid
```

**Rotas Protegidas:**
- GET /api/admin/plans
- POST /api/admin/plans
- PUT /api/admin/plans/:id
- DELETE /api/admin/plans/:id
- GET /api/admin/subscriptions
- POST /api/admin/subscriptions
- DELETE /api/admin/subscriptions/:id
- GET /api/admin/payments/pending
- POST /api/admin/payments/approve/:id
- GET /api/admin/users
- GET /api/admin/stats
- GET /api/admin/config
- PUT /api/admin/config

**Credenciais PadrÃ£o:**
```
Email: rodrigoconexao128@gmail.com
Senha: Ibira2019!
```

**Extrair Admin ID:**
```typescript
const adminId = (req.session as any)?.adminId;
```

---

## ğŸ› ï¸ Adicionar Nova Rota

### Passo 1: Adicionar funÃ§Ã£o em storage.ts
```typescript
async getMyData(userId: string) {
  const [data] = await db
    .select()
    .from(myTable)
    .where(eq(myTable.userId, userId));
  return data;
}
```

### Passo 2: Adicionar rota em routes.ts
```typescript
app.get("/api/my-data", isAuthenticated, async (req: any, res) => {
  try {
    const userId = req.user.claims.sub;
    const data = await storage.getMyData(userId);
    res.json(data);
  } catch (error) {
    console.error("Error:", error);
    res.status(500).json({ message: "Internal server error" });
  }
});
```

### Passo 3: Chamar do frontend
```typescript
const { data } = await apiRequest("/api/my-data");
```

---

## ğŸ§ª Testar Rota

### Com curl
```bash
# UsuÃ¡rio final
curl -X GET http://localhost:5000/api/my-data \
  -H "Authorization: Bearer <token>"

# Admin
curl -X GET http://localhost:5000/api/admin/config \
  -H "Cookie: connect.sid=<cookie>"
```

### Com Node.js
```javascript
const res = await fetch('http://localhost:5000/api/my-data', {
  headers: { 'Authorization': `Bearer ${token}` }
});
const data = await res.json();
```

---

## ğŸ“Š Estrutura de Banco

### Tabelas Principais

| Tabela | DescriÃ§Ã£o | Chave PrimÃ¡ria |
|--------|-----------|----------------|
| users | UsuÃ¡rios finais | id (UUID) |
| admins | Administradores | id (UUID) |
| plans | Planos de assinatura | id (UUID) |
| subscriptions | Assinaturas de usuÃ¡rios | id (UUID) |
| payments | Pagamentos PIX | id (UUID) |
| whatsapp_connections | ConexÃµes WhatsApp | id (UUID) |
| conversations | Conversas | id (UUID) |
| messages | Mensagens | id (UUID) |
| ai_agent_config | Config do agente | id (UUID) |
| system_config | Config do sistema | id (UUID) |
| sessions | SessÃµes admin | sid (string) |

---

## ğŸš€ Comandos Ãšteis

### Desenvolvimento
```bash
npm run dev              # Inicia servidor em modo dev
npm run build            # Build para produÃ§Ã£o
npm run start            # Inicia servidor em produÃ§Ã£o
```

### Debug
```bash
DEBUG_AUTH=1 npm run dev # Ativa logs de autenticaÃ§Ã£o
```

### Banco de Dados
```bash
npm run db:push          # Sincroniza schema com banco
npm run db:studio        # Abre Drizzle Studio
```

---

## ğŸ” Encontrar CÃ³digo

### Onde estÃ¡...?

**Login de usuÃ¡rio?**
- Frontend: `client/src/pages/login.tsx`
- Backend: `server/supabaseAuth.ts` (linhas 160-195)

**Login de admin?**
- Frontend: `client/src/pages/admin-login.tsx`
- Backend: `server/routes.ts` (linhas 35-71)

**ProteÃ§Ã£o de rota?**
- UsuÃ¡rios: `server/supabaseAuth.ts` (linhas 199-229)
- Admin: `server/middleware.ts` (linhas 14-58)

**Envio de mensagem WhatsApp?**
- Backend: `server/routes.ts` (linhas ~300-350)
- IntegraÃ§Ã£o: `server/whatsapp.ts`

**Agente de IA?**
- Config: `server/routes.ts` (linhas ~600-700)
- LÃ³gica: `server/aiAgent.ts`

**Pagamento PIX?**
- GeraÃ§Ã£o: `server/routes.ts` (linhas ~500-550)
- AprovaÃ§Ã£o: `server/routes.ts` (linhas ~550-600)

**Admin Panel?**
- Frontend: `client/src/pages/admin.tsx`
- ProteÃ§Ã£o: `client/src/pages/admin.tsx` (useEffect)

---

## âš ï¸ Erros Comuns

### 401 Unauthorized
**Causa:** Token JWT invÃ¡lido ou expirado
**SoluÃ§Ã£o:** Fazer login novamente

### 403 Forbidden
**Causa:** UsuÃ¡rio nÃ£o tem permissÃ£o
**SoluÃ§Ã£o:** Verificar role do usuÃ¡rio

### 500 Internal Server Error
**SoluÃ§Ã£o:** Verificar logs do servidor

### Admin login retorna 401
**Causa:** Hash de senha incorreto
**SoluÃ§Ã£o:** Atualizar hash no banco

### /admin abre sem estar logado
**Causa:** ProteÃ§Ã£o de rota nÃ£o funciona
**SoluÃ§Ã£o:** Verificar useEffect em admin.tsx

### Agente de IA retorna 401
**Causa:** Chave Mistral vazia
**SoluÃ§Ã£o:** Configurar em Admin Panel â†’ ConfiguraÃ§Ãµes

---

## ğŸ“ Checklist Antes de Commitar

- [ ] CÃ³digo testado localmente
- [ ] Sem console.log de debug
- [ ] Sem arquivos temporÃ¡rios
- [ ] Mensagem de commit clara
- [ ] Sem quebra de funcionalidades existentes

---

## ğŸ¯ PrÃ³ximos Passos

1. **Leia SYSTEM_ARCHITECTURE.md** (15 min)
2. **Configure ambiente** (5 min)
3. **Teste autenticaÃ§Ã£o** (5 min)
4. **Escolha uma tarefa em DEVELOPMENT_TASKLIST.md** (5 min)
5. **Implemente** (30+ min)

---

## ğŸ“ ReferÃªncias RÃ¡pidas

**DocumentaÃ§Ã£o Oficial:**
- Supabase: https://supabase.com/docs
- Baileys: https://github.com/WhiskeySockets/Baileys
- Mistral: https://docs.mistral.ai
- Express: https://expressjs.com
- React: https://react.dev

**Arquivos CrÃ­ticos:**
- `server/supabaseAuth.ts` - AutenticaÃ§Ã£o
- `server/middleware.ts` - ProteÃ§Ã£o
- `server/routes.ts` - Rotas
- `shared/schema.ts` - Schema
- `client/src/pages/admin.tsx` - Admin Panel

---

**Ãšltima atualizaÃ§Ã£o:** Novembro 2025  
**VersÃ£o:** 1.0.0

